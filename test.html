<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數列與等差數列互動學習系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Noto+Serif+TC:ital,wght@1,400;1,700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; margin: 0; }
        .math-font { font-family: 'Noto Serif TC', serif; font-style: italic; font-weight: bold; }
        .subscript { font-size: 0.75em; vertical-align: sub; line-height: 0; font-style: normal; margin-left: 1px; }
        .formula-box { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 1rem; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        /* 側邊欄專用白色數學字體 */
        .white-math-font span, .white-math-font sub { color: white !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.FirebaseOps = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, query 
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, Fragment, useRef } = React;

        // --- 1. 定義常數與題目 ---
        const SEAT_OPTIONS = Array.from({ length: 30 }, (_, i) => (i + 1).toString().padStart(2, '0'));
        
        const LESSON_CONTENT = [
            { 
                id: 1, title: "一、 認識數列與項數 (參考課本 P8)", 
                desc: "1. 將數排成一列並以逗點分開，稱為數列，其中的每一個數稱為一項。已知一組排球員的背號數列為：$15, 18, 21, 22, 25, 28, 42, 48, 62, 67, 72, 74, 78$，請填入下列各項：", 
                questions: [
                    { id: "1_1", label: "首項(第 $a_1$ 項)", ans: "15" }, 
                    { id: "1_2", label: "第 4 項 $a_4$", ans: "22" }, 
                    { id: "1_3", label: "末項 (第 13 項) $a_{13}$", ans: "78" }
                ] 
            },
            { id: 2, title: "二、 觀察數列的規律 (參考課本 P9)", desc: "找出數列變化的邏輯，填入空格。", questions: [{ id: "2_1", label: "14, 18, 22, (?), 30, 34", ans: "26" }, { id: "2_2", label: "10, 4, -2, (?), -14, -20", ans: "-8" }, { id: "2_3", label: "1, 3, 9, 27, (?)", ans: "81" }, { id: "2_4", label: "1/3, 2/4, 3/5, (?), 5/7", ans: "4/6" }] },
            { id: 3, title: "三、 數列的一般項與求項 (參考課本 P11)", desc: "已知數列一般項為 $a_n = 4n - 50$。", questions: [{ id: "3_1_1", label: "第 1 項 $a_1$", ans: "-46" }, { id: "3_1_2", label: "第 2 項 $a_2$", ans: "-42" }, { id: "3_1_3", label: "第 3 項 $a_3$", ans: "-38" }, { id: "3_2", label: "第 25 項 $a_{25}$", ans: "50" }, { id: "3_3", label: "若 $a_k = 150$，則 $k =$", ans: "50" }] },
            { id: 4, title: "四、 等差數列的判別與公差 (參考課本 P13)", desc: "判別數列是否為等差數列，並求公差。", questions: [{ id: "4_1_a", label: "8, 5, 2, -1, -4, -7 是等差數列嗎？", ans: "是", type: "choice", options: ["是", "否"] }, { id: "4_1_b", label: "承上題，公差 $d =$", ans: "-3" }, { id: "4_2_a", label: "5, 5, 5, 5, 5 是等差數列嗎？", ans: "是", type: "choice", options: ["是", "否"] }, { id: "4_2_b", label: "承上題，公差 $d =$", ans: "0" }] },
            { id: 5, title: "五、 利用公差完成等差數列 (參考課本 P14)", desc: "觀察間隔，填入適合的數。", questions: [{ id: "5_1_a", label: "(?), 24, 28, 32, (?) 中的第一個數", ans: "20" }, { id: "5_1_b", label: "最後一個數", ans: "36" }, { id: "5_2_a", label: "4x, 2x, (?), (?) 中的第三個數", ans: "0" }, { id: "5_2_b", label: "第四個數", ans: "-2x" }] },
            { id: 6, title: "六、 等差數列公式應用 (參考課本 P16、17)", desc: "公式：$a_n = a_1 + (n - 1)d$", questions: [{ id: "6_1", label: "已知 $a_1=85, d=-6$，求 $a_{15} =$", ans: "1" }, { id: "6_2", label: "若末項為 -35，則此數列共有多少項？", ans: "21" }, { id: "6_3", label: "已知 $a_{10}=72, d=8$，求首項 $a_1 =$", ans: "0" }] },
            { id: 7, title: "七、 圖形規律與一般項 (參考課本 P18)", desc: "觀察下方的圓點圖形規律並根據圖片作答。", hasImage: true, imageUrl: "https://drive.google.com/uc?id=1luicpHmVrUGB2H927fWlxr3g1Re_vhKV", questions: [{ id: "7_1", label: "請求第 50 個圖案 ($a_{50}$) =", ans: "202" }, { id: "7_2", label: "請求第 50 個圖案 ($b_{50}$) =", ans: "151" }] },
            { id: 8, title: "八、 生活情境應用 (參考課本 P19)", desc: "目標存款金額計算。請以「2月1日」格式作答。", questions: [{ id: "8_1", label: "目標日期 (格式如：2月1日)", ans: "2月24日", hint: "計算需 54 天" }] },
            { id: 9, title: "九、 等差數列應用 (參考課本 P20、21)", desc: "若 $a, b, c$ 成等差數列，則 $b = (a+c)/2$ 稱為等差中項。", questions: [{ id: "9_1", label: "已知 -6, b, 22 成等差，則 $b =$", ans: "8" }, { id: "9_2", label: "已知 $a, b, c$ 三數成等差，且總和為 -54，則中項 $b =$", ans: "-18" }] }
        ];

        // --- 2. 工具組件 ---
        const RenderMath = ({ text, colorClass = "text-indigo-700", isSidebar = false }) => {
            if (!text) return null;
            const parts = text.split('$');
            return (
                <Fragment>
                    {parts.map((part, i) => {
                        if (i % 2 === 0) return <span key={i}>{part}</span>;
                        const mathSegments = part.split(/_(\{.*?\}|.)/);
                        return (
                            <span key={i} className={`math-font mx-0.5 ${colorClass} ${isSidebar ? 'white-math-font' : ''}`}>
                                {mathSegments.map((seg, j) => {
                                    if (j % 2 === 0) return seg;
                                    const cleanSeg = seg && seg.startsWith('{') ? seg.slice(1, -1) : seg;
                                    return <sub key={j} className="subscript">{cleanSeg}</sub>;
                                })}
                            </span>
                        );
                    })}
                </Fragment>
            );
        };

        const Icon = ({ type, className = "w-5 h-5" }) => {
            const icons = {
                calculator: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
                book: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>,
                trophy: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>,
                check: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2.5"><path d="M5 13l4 4L19 7" /></svg>,
                chevron: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M9 5l7 7-7 7" /></svg>,
                settings: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /></svg>
            };
            return icons[type] || null;
        };

        // --- 3. 頁面組件 ---
        function LoginPage({ onLogin, onAdmin }) {
            const [cls, setCls] = useState('201');
            const [seat, setSeat] = useState('01');
            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-indigo-50">
                    <div className="max-w-md w-full bg-white rounded-[3rem] shadow-2xl p-10 animate-fade-in border-4 border-white text-center">
                        <div className="bg-indigo-600 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl"><Icon type="calculator" className="text-white w-10 h-10" /></div>
                        <h1 className="text-4xl font-black text-slate-800 tracking-tighter italic">數列互動教室</h1>
                        <p className="text-slate-400 font-bold mt-4 mb-10 text-sm">免登入系統 · 即時進入作答</p>
                        <div className="space-y-6">
                            <div className="relative text-left">
                                <label className="absolute -top-2 left-5 px-2 bg-white text-[10px] font-black text-indigo-500 uppercase">班級</label>
                                <select className="w-full p-5 bg-slate-50 border-2 rounded-2xl font-black outline-none focus:border-indigo-400" value={cls} onChange={e => setCls(e.target.value)}><option value="201">201 班</option><option value="204">204 班</option></select>
                            </div>
                            <div className="relative text-left">
                                <label className="absolute -top-2 left-5 px-2 bg-white text-[10px] font-black text-indigo-500 uppercase">座號</label>
                                <select className="w-full p-5 bg-slate-50 border-2 rounded-2xl font-black outline-none focus:border-indigo-400" value={seat} onChange={e => setSeat(e.target.value)}>{SEAT_OPTIONS.map(n => <option key={n} value={n}>{n} 號</option>)}</select>
                            </div>
                            <button onClick={() => onLogin(cls, seat)} className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black text-xl shadow-lg shadow-indigo-100 active:scale-95 transition-all mt-4">進入教室</button>
                            <button onClick={onAdmin} className="w-full py-3 text-slate-300 font-bold text-xs hover:text-slate-500">教師管理入口</button>
                        </div>
                    </div>
                </div>
            );
        }

        function QuestionPage({ section, answers, onAns, onBack }) {
            return (
                <div className="bg-white border-2 border-slate-100 rounded-[3rem] shadow-2xl p-8 md:p-12 animate-fade-in mb-10 text-left">
                    <button onClick={onBack} className="mb-8 p-3 px-6 bg-slate-50 rounded-2xl font-black text-slate-400 hover:text-indigo-600 transition-all flex items-center gap-2">← 返回目錄</button>
                    <h2 className="text-3xl font-black text-slate-800 mb-2 tracking-tight"><RenderMath text={section.title} /></h2>
                    <p className="text-sm text-slate-500 font-bold mb-10 leading-relaxed"><RenderMath text={section.desc} /></p>
                    {section.hasImage && <div className="mb-10 bg-slate-50 rounded-[2.5rem] border border-slate-100 flex justify-center p-8 shadow-inner"><img src={section.imageUrl} className="max-h-[350px] rounded-xl" /></div>}
                    <div className="space-y-12">
                        {section.questions.map(q => {
                            const correct = answers[q.id] === q.ans;
                            const started = !!answers[q.id];
                            return (
                                <div key={q.id} className="space-y-5">
                                    <label className="text-lg font-black text-slate-700 block ml-2"><RenderMath text={q.label} /></label>
                                    {q.type === 'choice' ? (
                                        <div className="flex gap-4">
                                            {q.options.map(o => <button key={o} onClick={() => onAns(q.id, o)} className={`flex-1 py-6 rounded-[1.8rem] border-4 font-black text-xl transition-all ${answers[q.id] === o ? 'bg-indigo-600 border-indigo-600 text-white shadow-xl' : 'bg-white border-slate-100 text-slate-400'}`}>{o}</button>)}
                                        </div>
                                    ) : (
                                        <div className="relative">
                                            <input type="text" className={`w-full p-6 pr-16 rounded-[2rem] border-4 outline-none font-black text-2xl transition-all shadow-inner ${correct ? 'border-green-500 bg-green-50 text-green-700' : started ? 'border-red-100 bg-red-50 text-red-600' : 'border-slate-100 bg-slate-50 focus:border-indigo-600'}`} placeholder="輸入答案..." value={answers[q.id] || ''} onChange={e => onAns(q.id, e.target.value)} />
                                            <div className="absolute right-6 top-1/2 -translate-y-1/2">{correct ? <Icon type="check" className="text-green-500 w-10 h-10" /> : started ? <span className="text-red-300 font-black text-3xl">×</span> : null}</div>
                                        </div>
                                    )}
                                    {started && !correct && q.hint && <div className="p-5 bg-indigo-50 border-l-8 border-indigo-500 rounded-2xl text-sm text-indigo-800 font-bold italic animate-fade-in">提示：<RenderMath text={q.hint} /></div>}
                                </div>
                            );
                        })}
                    </div>
                    <div className="mt-16 flex justify-end"><button onClick={onBack} className="bg-slate-800 text-white px-12 py-5 rounded-[2rem] font-black shadow-xl hover:bg-indigo-600 transition-all active:scale-95">完成並返回目錄</button></div>
                </div>
            );
        }

        function TeacherPanel({ config, db, appId, students }) {
            const [p, setP] = useState('');
            const [ok, setOk] = useState(false);
            const [filterCls, setFilterCls] = useState('201');

            if (!ok) return (
                <div className="bg-white p-12 border-2 rounded-[3rem] shadow-xl max-w-md mx-auto text-center animate-fade-in">
                    <h2 className="text-2xl font-black mb-6 text-slate-800">教師管理驗證</h2>
                    <input type="password" value={p} onChange={e => setP(e.target.value)} className="w-full p-5 bg-slate-50 border-2 rounded-2xl mb-6 font-black text-center tracking-widest outline-none" placeholder="••••••" />
                    <button onClick={() => p === 'math627' ? setOk(true) : alert('密碼錯誤')} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">確認登入</button>
                </div>
            );

            return (
                <div className="space-y-8 animate-fade-in text-left">
                    <div className="bg-white p-8 border-2 rounded-[2.5rem] shadow-sm">
                        <h2 className="text-xl font-black mb-8 flex items-center gap-3"><Icon type="settings" className="text-indigo-600" /> 開放單元管理</h2>
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            {LESSON_CONTENT.map(s => <button key={s.id} onClick={() => {
                                const next = config.openSections.includes(s.id) ? config.openSections.filter(x => x !== s.id) : [...config.openSections, s.id];
                                window.FirebaseOps.setDoc(window.FirebaseOps.doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), { openSections: next });
                            }} className={`p-5 rounded-2xl border-4 font-black text-xs transition-all ${config.openSections.includes(s.id) ? 'bg-indigo-600 border-indigo-600 text-white shadow-lg' : 'bg-slate-50 border-slate-50 text-slate-300'}`}>{s.id}. {s.title.split(' ')[1]}</button>)}
                        </div>
                    </div>
                    <div className="bg-white border-2 rounded-[2.5rem] overflow-hidden shadow-sm">
                        <div className="p-8 border-b font-black flex justify-between items-center bg-slate-50/50">
                            <span className="text-slate-700 font-black">學生作答明細</span>
                            <select className="bg-white p-2 px-4 rounded-xl border font-bold text-sm outline-none" value={filterCls} onChange={e => setFilterCls(e.target.value)}><option value="201">201 班</option><option value="204">204 班</option></select>
                        </div>
                        <div className="overflow-x-auto"><table className="w-full text-left"><thead className="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest"><tr><th className="p-6">座號</th><th className="p-6">得分</th><th className="p-6">完成進度</th></tr></thead><tbody className="divide-y divide-slate-50">{students.filter(s => s.className === filterCls).sort((a,b)=>parseInt(a.seatNumber)-parseInt(b.seatNumber)).map(s => (<tr key={s.id} className="hover:bg-indigo-50/10"><td className="p-6 font-black">{s.seatNumber}</td><td className="p-6 text-indigo-600 font-black text-xl">{s.score || 0}</td><td className="p-6"><div className="w-32 h-3 bg-slate-100 rounded-full overflow-hidden shadow-inner"><div className="h-full bg-indigo-500 rounded-full" style={{width: `${((s.score||0)/31)*100}%`}} /></div></td></tr>))}</tbody></table></div>
                    </div>
                </div>
            );
        }

        // --- 4. 主程式 App ---
        function App() {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [activeSection, setActiveSection] = useState(null);
            const [studentAnswers, setStudentAnswers] = useState({});
            const [allStudents, setAllStudents] = useState([]);
            const [config, setConfig] = useState({ openSections: [1, 2, 3, 4, 5, 6, 7, 8, 9] });
            const [loading, setLoading] = useState(true);
            const dbRef = useRef(null);

            const firebaseConfig = JSON.parse(__firebase_config);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'math-lesson-stable-final-v13';

            // 初始化身份驗證 (遵守 Rule 3)
            useEffect(() => {
                const initAuth = async () => {
                    const OPS = window.FirebaseOps;
                    if (!OPS) return;
                    try {
                        const app = OPS.initializeApp(firebaseConfig);
                        const auth = OPS.getAuth(app);
                        const db = OPS.getFirestore(app);
                        dbRef.current = db;
                        
                        // 先嘗試身份驗證
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                          await OPS.signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                          await OPS.signInAnonymously(auth);
                        }

                        // 登入完成後監聽狀態
                        OPS.onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                            } else {
                                setUser(null);
                            }
                            setLoading(false);
                        });
                    } catch (e) { 
                        console.error("Init Error", e); 
                        setLoading(false); 
                    }
                };
                initAuth();
            }, []);

            // 資料監聽：必須在 User 成功登入後啟動 (解決權限錯誤)
            useEffect(() => {
                if (!user || !dbRef.current) return;
                const OPS = window.FirebaseOps;
                const db = dbRef.current;

                // 只有在 User 確認後才進行 Snapshot 監聽
                const unsubConfig = OPS.onSnapshot(OPS.doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), (ds) => {
                    if (ds.exists()) setConfig(ds.data());
                }, err => {
                    // 若發生權限錯誤，通常是因為資料庫尚未初始化，忽略之
                });

                const unsubStudents = OPS.onSnapshot(OPS.collection(db, 'artifacts', appId, 'public', 'data', 'students'), (snap) => {
                    setAllStudents(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, err => {
                    // 若發生權限錯誤，通常是因為資料庫尚未初始化，忽略之
                });

                return () => { unsubConfig(); unsubStudents(); };
            }, [user]);

            const loginAsStudent = async (cls, seat) => {
                const OPS = window.FirebaseOps;
                if (!dbRef.current || !user) return;
                const studentId = `${cls}_${seat}`;
                const studentRef = OPS.doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'students', studentId);
                const snap = await OPS.getDoc(studentRef);
                if (snap.exists()) setStudentAnswers(snap.data().answers || {});
                else await OPS.setDoc(studentRef, { className: cls, seatNumber: seat, score: 0, answers: {}, lastUpdate: Date.now() });
                setRole({ cls, seat });
            };

            const handleAns = async (qId, val) => {
                const OPS = window.FirebaseOps;
                if (!dbRef.current || !role || !user) return;
                const newAns = { ...studentAnswers, [qId]: val };
                setStudentAnswers(newAns);
                let score = 0;
                LESSON_CONTENT.forEach(s => s.questions.forEach(q => { if(newAns[q.id] === q.ans) score++; }));
                await OPS.updateDoc(OPS.doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'students', `${role.cls}_${role.seat}`), { answers: newAns, score, lastUpdate: Date.now() });
            };

            if (loading) return <div className="h-screen flex flex-col items-center justify-center font-black text-indigo-400 text-xl animate-pulse">正在開啟互動教室...</div>;

            if (!role) return <LoginPage onLogin={loginAsStudent} onAdmin={() => setRole('teacher')} />;

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans animate-fade-in">
                    <nav className="bg-white border-b h-16 sticky top-0 z-50 px-6 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-2"><div className="p-2 bg-indigo-600 rounded-lg shadow-md"><Icon type="book" className="text-white w-4 h-4" /></div><span className="font-black text-xl text-slate-800 italic">數列互動教室</span></div>
                        <div className="flex items-center gap-4">
                            <span className="text-xs font-bold bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full uppercase tracking-tighter">{role === 'teacher' ? 'Admin' : `${role.cls}-${role.seat}`}</span>
                            <button onClick={() => setRole(null)} className="p-2 px-5 bg-slate-100 hover:bg-slate-200 rounded-xl text-xs font-black transition-all">登出</button>
                        </div>
                    </nav>

                    <main className="flex-1 max-w-6xl w-full mx-auto p-4 md:p-8 flex flex-col md:flex-row gap-8">
                        <div className="flex-1">
                            {role === 'teacher' ? (
                                <TeacherPanel config={config} db={dbRef.current} appId={appId} students={allStudents} />
                            ) : activeSection ? (
                                <QuestionPage section={LESSON_CONTENT.find(s => s.id === activeSection)} answers={studentAnswers} onAns={handleAns} onBack={() => setActiveSection(null)} />
                            ) : (
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 text-left">
                                    {LESSON_CONTENT.map(s => {
                                        const open = config.openSections.includes(s.id);
                                        const done = s.questions.filter(q => studentAnswers[q.id] === q.ans).length;
                                        return (
                                            <div key={s.id} onClick={() => open && setActiveSection(s.id)} className={`group p-8 bg-white border-2 rounded-[2.5rem] transition-all relative overflow-hidden ${open ? 'cursor-pointer border-slate-100 hover:border-indigo-600 hover:shadow-2xl' : 'opacity-40 grayscale pointer-events-none'}`}>
                                                <div className="flex justify-between items-start mb-4"><div className={`p-3 rounded-2xl ${open ? 'bg-indigo-50 text-indigo-600' : 'bg-slate-100'}`}><Icon type={open ? "book" : "lock"} /></div><span className="text-[10px] font-black text-slate-300 tracking-widest uppercase font-mono">Unit 0{s.id}</span></div>
                                                <h3 className="font-black text-slate-800 text-xl mb-2 group-hover:text-indigo-600 transition-colors"><RenderMath text={s.title} /></h3>
                                                <p className="text-xs text-slate-400 font-bold leading-relaxed mb-8 line-clamp-2"><RenderMath text={s.desc} /></p>
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-3"><div className="w-20 h-2 bg-slate-100 rounded-full overflow-hidden shadow-inner"><div className="h-full bg-indigo-500 transition-all duration-700" style={{width: `${(done/s.questions.length)*100}%`}} /></div><span className="text-[10px] font-black text-indigo-400">{done}/{s.questions.length}</span></div>
                                                    <Icon type="chevron" className="text-indigo-600" />
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        <aside className="w-full md:w-80 space-y-6 text-left">
                            <div className="bg-white border-2 border-slate-100 rounded-[2.5rem] p-8 shadow-sm">
                                <h2 className="font-black text-slate-800 mb-6 flex items-center gap-3"><Icon type="trophy" className="text-amber-500" /> 排行榜 ({role.cls || '201'})</h2>
                                <div className="space-y-3">
                                    {allStudents.filter(s => s.className === (role.cls || '201')).sort((a,b)=>(b.score||0)-(a.score||0) || parseInt(a.seatNumber)-parseInt(b.seatNumber)).slice(0, 10).map((s, i) => (
                                        <div key={i} className="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border-2 border-transparent hover:border-indigo-100 transition-all font-bold">
                                            <div className="flex items-center gap-3"><span className={`w-5 h-5 rounded-lg flex items-center justify-center text-[10px] ${i < 3 ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-200'}`}>{i+1}</span> <span>{s.seatNumber} 號</span></div>
                                            <span className="text-indigo-600 font-black">{s.score || 0} pnt</span>
                                        </div>
                                    ))}
                                    {allStudents.filter(s => s.className === (role.cls || '201')).length === 0 && <p className="text-center py-10 text-slate-300 font-bold italic text-xs">目前尚無數據</p>}
                                </div>
                            </div>
                            <div className="bg-slate-800 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden group">
                                <Icon type="calculator" className="absolute -top-6 -right-6 w-40 h-40 opacity-10 group-hover:rotate-12 transition-transform duration-700" />
                                <h3 className="text-slate-400 text-[10px] font-black uppercase mb-6 tracking-widest">概念小幫手 Helpful Tip</h3>
                                <div className="text-sm font-bold space-y-6 text-white sidebar-math">
                                    <p>等差數列就像是在走階段階梯。</p>
                                    <p>首項 <RenderMath text="$a_1$" colorClass="text-white" isSidebar={true} /> 是起點的高度，公差 <RenderMath text="$d$" colorClass="text-white" isSidebar={true} /> 是每一階的固定寬度。</p>
                                    <div className="formula-box p-5 text-center shadow-inner">
                                        <div className="text-[10px] font-black text-slate-400 uppercase mb-2 tracking-tighter">公式 Formula</div>
                                        <div className="text-xl tracking-wide"><RenderMath text="$a_n = a_1 + (n-1)d$" colorClass="text-white" isSidebar={true} /></div>
                                    </div>
                                </div>
                            </div>
                        </aside>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
